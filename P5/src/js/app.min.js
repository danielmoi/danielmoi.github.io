function initMap(){ko.applyBindings(new ViewModel)}function mapError(e,o,n,r,t){console.log("Error message: "+e+", Script URL: "+o+", Line number: "+n+", Col number: "+r+", Error object: "+t),$("#message").text('system error: "'+e+'"'),$("#error").text("sorry, something went wrong with Google Maps... try again soon! (we've sent our code kitten to find out what's wrong!)"),$("#map").append('<div id="error"><img src="img/cat.jpg"></div>')}var model=[{}],ViewModel=function(){var e=this;"undefined"==typeof google&&mapError(),e.markerIconStar={url:"img/coffee_star_32.png"},e.markerIconNormal={url:"img/coffee_normal_32.png"},e.mapOptions={center:{lat:35.667,lng:139.762},zoom:16,zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},mapTypeId:google.maps.MapTypeId.ROADMAP,styles:[{featureType:"poi",stylers:[{visibility:"off"}]}]},e.myMap=new google.maps.Map(document.getElementById("map"),e.mapOptions),e.myInfo=new google.maps.InfoWindow({maxWidth:200}),e.bounds=new google.maps.LatLngBounds,e.widthMagic=ko.computed(function(){return e.mapWidth=ko.observable(window.innerWidth),e.mapWidth()<600&&e.myMap.addListener("click",function(){e.navHide()}),e.mapWidth()}),window.onresize=function(){console.log("window resized"),e.myMap.fitBounds(e.bounds),e.widthMagic()},e.myMap.addListener("click",function(){e.myInfo.close()}),e.city=ko.observable("Tokyo"),e.cafeArray=ko.observableArray(),e.start="https://api.foursquare.com/v2/venues/explore?",e.client_id="client_id=J4JTA0KKSKB50R1ONPYB3W4H532SPS403IHJKL4VQMNMNKT0",e.client_secret="&client_secret=W5FBT3FTE1X4RVJXPSJJDNNXCYHXL0OMH1TPVINZ40NO0LX5",e.location=ko.computed(function(){return"&near="+e.city()}),e.limit="&limit=20",e.v="&v=20140806",e.m="&m=foursquare",e.section="&section=coffee",e.venuePhotos="&venuePhotos=1",e.radius="&radius=1000",e.filterValue=ko.observable(""),e.filterValueLower=ko.observable(e.filterValue().toLowerCase()),e.filterStuff=ko.computed(function(){var o,n=e.cafeArray().length,r=e.filterValue().toLowerCase();for(o=0;n>o;o++){e.myInfo.close();var t=e.cafeArray()[o].name.toLowerCase();t.indexOf(r)<0?(e.cafeArray()[o].marker.setVisible(!1),e.cafeArray()[o].visible(!1)):(e.cafeArray()[o].marker.setVisible(!0),e.cafeArray()[o].visible(!0))}}),e.clearFilter=function(){e.filterValue("")},e.navClick=function(){$("#side").slideToggle("slow"),$("#nav-button").toggleClass("fa-chevron-down")},e.navHide=function(){$("#side").slideUp("slow"),$("#nav-button").addClass("fa-chevron-down")},e.message=ko.observable("no errors to report"),e.messageSimple=ko.observable(),e.getStuff=function(){$.ajax({url:e.start+e.client_id+e.client_secret+e.location()+e.v+e.m+e.limit+e.section+e.venuePhotos+e.radius,success:function(o){e.filterValue(""),e.cafeArray([]),e.message(""),e.messageSimple(""),console.log(e.cafeArray()),e.bounds=new google.maps.LatLngBounds,e.mapOptions.center=o.response.geocode.center;var n,r=o.response.groups[0].items;for(n=0;n<r.length;n++)e.cafeArray.push(new Cafe(r,n,e));console.log(e.cafeArray())},error:function(o,n,r){e.message('system error: "'+n+"â€“"+r+'"'),e.messageSimple("sorry, something went wrong... try a different location!")}})},e.getStuff()},Cafe=function(e,o,n){var r=this;r.name=e[o].venue.name,r.lat=e[o].venue.location.lat,r.lng=e[o].venue.location.lng,r.rating=e[o].venue.rating,r.visible=ko.observable(!0),r.isSelected=ko.observable(!1),n.message("no errors to report"),e[o].venue.featuredPhotos?r.photoURL=e[o].venue.featuredPhotos.items[0].prefix+"height200"+e[o].venue.featuredPhotos.items[0].suffix:(n.message("sorry, no featured photos available"),console.log("NO PHOTOS!!"),r.photoURL="#"),r.rating>8.5?r.marker=new google.maps.Marker({map:n.myMap,position:{lat:r.lat,lng:r.lng},icon:n.markerIconStar,title:r.name}):r.marker=new google.maps.Marker({map:n.myMap,position:{lat:r.lat,lng:r.lng},icon:n.markerIconNormal,title:r.name}),r.marker.addListener("click",function(){n.myInfo.setContent("<h3>"+r.name+'</h3><img src="img/foursquare-icon-16x16.png"> Rating: '+r.rating+'<br><img src="'+r.photoURL+'">'),n.myInfo.open(n.myMap,r.marker),n.mapOptions.center=r.marker,n.myMap.panTo(r.marker.position);var e=n.myMap.getDiv();console.log(e.offsetHeight),n.myMap.panBy(0,-e.offsetHeight/5),r.marker.setAnimation(google.maps.Animation.BOUNCE),window.setTimeout(function(){r.marker.setAnimation(null)},1400);var o;for(o=0;o<n.cafeArray().length;o++)n.cafeArray()[o].isSelected(!1);r.isSelected(!0),n.mapWidth()<600&&n.navHide()}),r.listClick=function(){google.maps.event.trigger(r.marker,"click")},n.bounds.extend(new google.maps.LatLng(r.lat,r.lng)),n.myMap.fitBounds(n.bounds)};